################################################################################
# DataSHIELD GHA test suite - dsBaseClient
# Matrix-driven from curated refs file (.github/dsbaseclient-refs.txt)
################################################################################
name: dsBaseClient tests' suite

on:
  push:
  schedule:
    - cron: '0 0 * * 6'   # weekly
    # - cron: '0 1 * * *'   # nightly
  workflow_dispatch:

env:
  TARGET_REPOSITORY: datashield/dsBaseClient
  PROJECT_NAME: dsBaseClient

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      refs: ${{ steps.refs.outputs.refs }}
    steps:
      - uses: actions/checkout@v4

      - name: Read curated refs file (.github/dsbaseclient-refs.txt)
        id: refs
        run: |
          if [ ! -f .github/dsbaseclient-refs.txt ]; then
            echo "ERROR: .github/dsbaseclient-refs.txt not found."
            exit 1
          fi

          # Remove comments and empty lines, convert to JSON array
          REFS=$(grep -v '^\s*#' .github/dsbaseclient-refs.txt | grep -v '^\s*$' | jq -R -s -c 'split("\n")[:-1]')
          echo "Using refs: $REFS"
          echo "refs=$REFS" >> $GITHUB_OUTPUT

  dsBaseClient_test_suite:
    needs: set-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        ref: ${{ fromJson(needs.set-matrix.outputs.refs) }}

    env:
      TEST_FILTER: '_-|datachk-|smk-|arg-|disc-|perf-|smk_expt-|expt-|math-'
      _r_check_system_clock_: 0
      WORKFLOW_ID: ${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.ref }}
      REF_NAME: ${{ matrix.ref }}
      REPO_OWNER: ${{ github.repository_owner }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - name: Checkout dsBaseClient
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPOSITORY }}
          token: ${{ github.token }}
          ref: ${{ matrix.ref }}
          fetch-depth: 0
          path: dsBaseClient

      - name: Checkout dsTestsDashboard
        uses: actions/checkout@v4
        with:
          path: dsTestsDashboard

      - name: Uninstall default MySQL
        run: |
          curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -
          sudo service mysql stop || true
          sudo apt-get update
          sudo apt-get remove --purge mysql-client mysql-server mysql-common -y
          sudo apt-get autoremove -y
          sudo apt-get autoclean -y
          sudo rm -rf /var/lib/mysql/

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: release
          http-user-agent: release
          use-public-rspm: true

      - name: Install R and dependencies
        run: |
          sudo apt-get install --no-install-recommends software-properties-common dirmngr -y
          wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
          sudo add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
          sudo apt-get update -qq
          sudo apt-get upgrade -y
          sudo apt-get install -qq libxml2-dev libcurl4-openssl-dev libssl-dev libgsl-dev libgit2-dev r-base -y
          sudo apt-get install -qq libharfbuzz-dev libfribidi-dev libmagick++-dev xml-twig-tools -y
          sudo R -q -e "install.packages(c('devtools','covr','fields','meta','metafor','ggplot2','gridExtra','data.table','DSI','DSOpal','DSLite','MolgenisAuth','MolgenisArmadillo','DSMolgenisArmadillo','DescTools','e1071'), repos='https://cloud.r-project.org')"
          sudo R -q -e "devtools::install_github(repo='datashield/dsDangerClient', ref=Sys.getenv('REF_NAME'))"

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          dependencies: 'c("Imports")'
          extra-packages: |
            any::rcmdcheck
            cran::devtools
            cran::git2r
            cran::RCurl
            cran::readr
            cran::magrittr
            cran::xml2
            cran::purrr
            cran::dplyr
            cran::stringr
            cran::tidyr
            cran::quarto
            cran::knitr
            cran::kableExtra
            cran::rmarkdown
            cran::downlit
          needs: check

      - name: Check manual updated
        run: |
          orig_sum=$(find man -type f | sort -u | xargs cat | md5sum)
          R -q -e "devtools::document()"
          new_sum=$(find man -type f | sort -u | xargs cat | md5sum)
          if [ "$orig_sum" != "$new_sum" ]; then
            echo "Your committed man/*.Rd files are out of sync."
            exit 1
          fi
        working-directory: dsBaseClient
        continue-on-error: true

      - name: Devtools checks
        run: |
          R -q -e "devtools::check(args = c('--no-examples', '--no-tests'))" | tee azure-pipelines_check.Rout
        working-directory: dsBaseClient
        continue-on-error: true

      - name: Start Armadillo docker-compose
        run: docker compose -f docker-compose_armadillo.yml up -d --build
        working-directory: dsBaseClient

      - name: Install test datasets
        run: |
          sleep 60
          R -q -f "molgenis_armadillo-upload_testing_datasets.R"
        working-directory: dsBaseClient/tests/testthat/data_files

      - name: Install latest dsBase to Armadillo
        run: |
          set -e

          echo "Looking for dsBase_* -permissive tarballs..."
          ls -1 dsBase_*-permissive.tar.gz || true

          # find latest version using version sort (-V handles X.Y.Z correctly)
          LATEST_TARBALL=$(ls -1 dsBase_*-permissive.tar.gz 2>/dev/null | sort -V | tail -n 1)

          if [ -z "$LATEST_TARBALL" ]; then
            echo "❌ No dsBase_* -permissive.tar.gz file found in repo"
            exit 1
          fi

          echo "✅ Latest dsBase package detected: $LATEST_TARBALL"

          # extract version for logging
          VERSION=$(echo "$LATEST_TARBALL" | sed -E 's/^dsBase_([0-9.]+)-permissive\.tar\.gz$/\1/')
          echo "Installing dsBase version: $VERSION"

          # check Armadillo API is reachable
          curl -u admin:admin -X GET http://localhost:8080/packages

          # install the latest tarball
          curl -u admin:admin \
            -H 'Content-Type: multipart/form-data' \
            -F "file=@${LATEST_TARBALL}" \
            -X POST http://localhost:8080/install-package

          sleep 60
          docker restart dsbaseclient-armadillo-1
          sleep 30

          # whitelist dsBase (package name stays constant)
          curl -u admin:admin -X POST http://localhost:8080/whitelist/dsBase
        working-directory: dsBaseClient

      - name: Run tests with coverage & JUnit report
        run: |
          mkdir -p logs
          R -q -e '
            write.csv(
              covr::coverage_to_list(
                covr::package_coverage(
                  type = c("none"),
                  code = c('"'"'
                    junit_rep <- testthat::JunitReporter$new(file = "test_results.xml");
                    progress_rep <- testthat::ProgressReporter$new(max_failures = 999999);
                    multi_rep <- testthat::MultiReporter$new(reporters = list(progress_rep, junit_rep));
                    options("datashield.return_errors" = FALSE);
                    testthat::test_package("${{ env.PROJECT_NAME }}",
                                           filter = "${{ env.TEST_FILTER }}",
                                           reporter = multi_rep,
                                           stop_on_failure = FALSE)'"'"'
                  )
                )
              ),
              "coveragelist.csv"
            )'
          mv *.csv logs/ || true
          mv *.xml logs/ || true
          grep -q " FAIL 0 " logs/test_console_output.txt
        working-directory: dsBaseClient

      - name: Check for JUnit errors
        run: |
          issue_count=$(sed 's/failures="0" errors="0"//' test_results.xml | grep -c errors= || true)
          echo "Number of testsuites with issues: $issue_count"
          sed 's/failures="0" errors="0"//' test_results.xml | grep errors= > issues.log || true
          cat issues.log || true
          exit $issue_count
        working-directory: dsBaseClient/logs

      - name: Write versions to file
        run: |
          echo "ref:${{ env.REF_NAME }}" > ${{ env.WORKFLOW_ID }}.txt
          echo "os:$(lsb_release -ds)" >> ${{ env.WORKFLOW_ID }}.txt
          echo "R:$(R --version | head -n1)" >> ${{ env.WORKFLOW_ID }}.txt
          Rscript --vanilla -e 'sessionInfo()' >> session_info_${{ env.WORKFLOW_ID }}.txt
        working-directory: dsBaseClient/logs

      - name: Parse results from testthat and covr
        run: |
          Rscript --verbose --vanilla ../dsTestsDashboard/source/parse_test_report.R logs/
        working-directory: dsBaseClient

      - name: Commit results to dsTestsDashboard
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          cd dsTestsDashboard

          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ env.REPO_OWNER }}/dsTestsDashboard.git
          git checkout
          git pull origin

          mkdir -p logs/${{ env.PROJECT_NAME }}/${{ env.REF_NAME }}/${{ env.WORKFLOW_ID }}/

          cp -rv ../dsBaseClient/logs/* logs/${{ env.PROJECT_NAME }}/${{ env.REF_NAME }}/${{ env.WORKFLOW_ID }}/
          cp -rv ../dsBaseClient/logs/${{ env.WORKFLOW_ID }}.txt logs/${{ env.PROJECT_NAME }}/${{ env.REF_NAME }}/${{ env.WORKFLOW_ID }}/

          ln -sf ${{ env.WORKFLOW_ID }}/ logs/${{ env.PROJECT_NAME }}/${{ env.REF_NAME }}/.LATEST

          git add .
          git commit -m "Auto test for ${{ env.PROJECT_NAME }}/${{ env.REF_NAME }} @ ${{ env.WORKFLOW_ID }}" || echo "No changes to commit"
          git push origin

        env:
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          REF_NAME: ${{ env.REF_NAME }}
          WORKFLOW_ID: ${{ env.WORKFLOW_ID }}

      - name: Dump environment info
        run: |
          echo -e "\n#############################"
          echo -e "ls /: ######################"
          ls -al .
          echo -e "\n#############################"
          echo -e "lscpu: ######################"
          lscpu
          echo -e "\n#############################"
          echo -e "memory: #####################"
          free -m
          echo -e "\n#############################"
          echo -e "env: ########################"
          env
          echo -e "\n#############################"
          echo -e "R sessionInfo(): ############"
          R -e 'sessionInfo()'
          sudo apt install tree -y
          tree .
